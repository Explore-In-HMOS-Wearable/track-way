import { image } from '@kit.ImageKit';
import { generateBarcode, scanCore } from '@kit.ScanKit';

@Builder
export function QRGenerateKitPageBuilder() {
  QRGenerateKitPage();
}

@Component
struct QRGenerateKitPage {
  @Consume('NavPathStack') pageStack: NavPathStack;
  @State qrCodeInput: string = 'HelloQR!';
  @State qrPixelMap: image.PixelMap | null = null;
  @State isLoading: boolean = true;

  private readonly QR_CODE_SIZE: number = 220;
  private readonly QR_CODE_MARGIN: number = 3;
  private readonly QR_CODE_BACKGROUND_COLOR: number = 0xFFFFFF;
  private readonly QR_CODE_FOREGROUND_COLOR: number = 0x000000;
  private readonly QR_ERROR_LEVEL: generateBarcode.ErrorCorrectionLevel = generateBarcode.ErrorCorrectionLevel.LEVEL_H;

  async aboutToAppear(): Promise<void> {
    this.isLoading = true;
    console.log('QRGenerateKitPage: aboutToAppear - Starting QR code generation with ScanKit.');

    this.qrCodeInput = this.pageStack.getParamByName('QRGenerateKitPage')[0] as string;


    await this.generateAndDisplayQRCode();
    this.isLoading = false;
    console.log(`QRGenerateKitPage: Generation finished. qrPixelMap is null: ${this.qrPixelMap === null}`);
  }

  aboutToDisappear() {
    if (this.qrPixelMap) {
      console.log('QRGenerateKitPage: Releasing qrPixelMap resources.');
      this.qrPixelMap.release();
      this.qrPixelMap = null;
    }
  }

  async generateAndDisplayQRCode(): Promise<void> {
    const options: generateBarcode.CreateOptions = {
      scanType: scanCore.ScanType.QR_CODE,
      width: this.QR_CODE_SIZE,
      height: this.QR_CODE_SIZE,
      margin: this.QR_CODE_MARGIN,
      level: this.QR_ERROR_LEVEL,
      backgroundColor: this.QR_CODE_BACKGROUND_COLOR,
      pixelMapColor: this.QR_CODE_FOREGROUND_COLOR,
    };

    try {
      console.log(`QRGenerateKitPage: Generating QR code for "${this.qrCodeInput}" with ScanKit.`);
      const newPixelMap: image.PixelMap = await generateBarcode.createBarcode(this.qrCodeInput, options);
      this.qrPixelMap = newPixelMap;
      console.log('QRGenerateKitPage: QR Code PixelMap generated successfully by ScanKit.');
    } catch (error) {
      if (error) {
        console.error(`QRGenerateKitPage: Failed to create QR code with ScanKit. Code: ${error.code}, Message: ${error.message}`);
      } else {
        console.error(`QRGenerateKitPage: Unexpected error during QR code generation: ${JSON.stringify(error)}`);
      }
      this.qrPixelMap = null;
    }
  }

  build() {
    NavDestination() {
      Flex({ justifyContent: FlexAlign.Center, alignItems: ItemAlign.Center }) {
        Column({ space: 10 }) {
          Text('Generated by\nScan Kit')
            .fontColor(Color.White)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
          if (this.isLoading) {
            Progress({
              type: ProgressType.Ring,
              value: 0,
            })
              .width(40)
              .height(40)
          } else {
            if (this.qrPixelMap) {
              Row() {
                Image(this.qrPixelMap)
                  .width('50%')
                  .aspectRatio(1)
                  .alignSelf(ItemAlign.Center)
              }
              .padding(2)
              .backgroundColor(Color.White)
            } else {
              Text('Failed to load QR Code.')
                .width('100%')
                .textAlign(TextAlign.Center)
                .fontColor(Color.Red)
                .fontSize(14)
            }
          }

          Text('Scan Me')
            .fontColor(Color.White)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
        }
        .width('100%')
        .height('100%')
        .alignItems(HorizontalAlign.Center)
        .justifyContent(FlexAlign.Center)
      }
      .backgroundColor(Color.Black)
      .width('100%')
      .height('100%')
    }
    .hideTitleBar(true)
    .hideBackButton(true)
  }
}
import { image } from '@kit.ImageKit';
import { generateBarcode, scanCore } from '@kit.ScanKit';

@Builder
export function QRGenerateKitPageBuilder() {
  QRGenerateKitPage();
}

@Component
export struct QRGenerateKitPage {
  @Consume('pageInfos') pageStack: NavPathStack;

  private qrCodeInput: string = 'HelloQR!';

  @State qrPixelMap: image.PixelMap | null = null;
  @State isLoading: boolean = true;

  private readonly QR_CODE_SIZE: number = 220;
  private readonly QR_CODE_MARGIN: number = 3;
  private readonly QR_CODE_BACKGROUND_COLOR: number = 0xFFFFFF;
  private readonly QR_CODE_FOREGROUND_COLOR: number = 0x000000;
  private readonly QR_ERROR_LEVEL: generateBarcode.ErrorCorrectionLevel = generateBarcode.ErrorCorrectionLevel.LEVEL_H;

  async aboutToAppear(): Promise<void> {
    this.isLoading = true;

    const params = this.pageStack.getParamByName('QRGenerateKitPage') as string[];

    if (params && params.length > 0) {
      this.qrCodeInput = params[0] as string;
    }

    await this.generateAndDisplayQRCode();
    this.isLoading = false;
  }

  aboutToDisappear() {
    if (this.qrPixelMap) {
      this.qrPixelMap.release();
      this.qrPixelMap = null;
    }
  }

  async generateAndDisplayQRCode(): Promise<void> {
    const options: generateBarcode.CreateOptions = {
      scanType: scanCore.ScanType.QR_CODE,
      width: this.QR_CODE_SIZE,
      height: this.QR_CODE_SIZE,
      margin: this.QR_CODE_MARGIN,
      level: this.QR_ERROR_LEVEL,
      backgroundColor: this.QR_CODE_BACKGROUND_COLOR,
      pixelMapColor: this.QR_CODE_FOREGROUND_COLOR
    };

    try {
      const newPixelMap: image.PixelMap = await generateBarcode.createBarcode(this.qrCodeInput, options);
      this.qrPixelMap = newPixelMap;
    } catch (error) {
      if (error) {
        console.error(`QRGenerateKitPage: Failed to create QR code with ScanKit. Code: ${error.code}, Message: ${error.message}`);
      } else {
        console.error(`QRGenerateKitPage: Unexpected error during QR code generation.`);
      }
      this.qrPixelMap = null;
    }
  }

  build() {
    NavDestination() {
      Flex({ justifyContent: FlexAlign.Center, alignItems: ItemAlign.Center }) {
        Column({ space: 20 }) {

          Text('Generated by\nScan Kit')
            .fontColor(Color.White)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .textAlign(TextAlign.Center)

          if (this.isLoading) {
            LoadingProgress()
              .width(50)
              .height(50)
              .color(Color.White)
          } else {
            if (this.qrPixelMap) {
              Column() {
                Image(this.qrPixelMap)
                  .width(220)
                  .height(220)
                  .objectFit(ImageFit.Contain)
              }
              .padding(10)
              .backgroundColor(Color.White)
              .borderRadius(12)
            } else {
              Text('Failed to load QR Code.')
                .width('100%')
                .textAlign(TextAlign.Center)
                .fontColor(Color.Red)
                .fontSize(16)
            }
          }

          Text('Scan Me')
            .fontColor(Color.White)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .opacity(0.8)
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
        .justifyContent(FlexAlign.Center)
      }
      .backgroundColor(Color.Black)
      .width('100%')
      .height('100%')
    }
    .hideTitleBar(true)
    .hideBackButton(true)
  }
}